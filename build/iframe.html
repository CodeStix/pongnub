<!DOCTYPE html>
<!--<![endif]-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>PongNub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5">
  <link rel="icon" type="image/png" href="//www.pubnub.com/static/images/structure/favicon.png">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Press+Start+2P">
  <link rel="stylesheet" href="//www.pubnub.com/static/css/styles.css?ts=1404164785">
  <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/pong.css">
  <link href="node_modules/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <style media="screen">
    body {
      background-color: white;
    }
    #app-hero {
      background:white;
      background-attachment: fixed;
    }
    #demo {
      background: white;
      background-attachment: fixed;
    }
    #game {
      display: block;
      /*margin: 0 auto;*/
    }
    #qrcode {
      display: block;
      margin: 20px auto;
      text-align: center;
    }

    #areana {
      top: 0px;
      position: relative;
      left: 126px;
    }

    iframe {
      min-width: 640px;
      min-height: 480px;
      margin: 0 auto;
    }

    .vbox {
      display: flex;
      flex-direction: column;
    }
    .description {
      padding: 0.5em 2em;
      max-width: 30em;
      margin: 0 auto;
    }
  </style>
</head>

<body data-ember-extension="1">

  <div id="alert_container" class="alert  hidden"></div>
    <div class="vbox">

      <h1 class="text-center" style="font-family: 'Press Start 2P', cursive;">PongNub</h1>

      <p class="text-center description">
      Build and play the classic arcade video game, Pong, using PubNub. Read the QR code below to play from your mobile device or open up another window to access the controls from your browser.
      </p>
      <a href="" id="controlLink" target="_blank">Controls</a>
      <div id="qrcode" style="display: inline-block;"></div>

      <div class="modal fade bs-example-modal-sm" id="playAgain">
        <div class="modal-dialog modal-sm">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
              <h4 class="modal-title">Play Again?</h4>
            </div>
            <div class="modal-body">
              <button type="button" class="btn btn-default" data-dismiss="modal">Nah I'm good</button>
              <button type="button" class="btn btn-primary" id="REMATCH">REMATCH NOW</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

      <iframe id="game" src="img/blank.png" width="640" height="480" scrolling="no" seamless="seamless" frameborder="0">
          <p>Your browser does not support iframes.</p>
      </iframe>

    </div>

  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

  <script src="js/game.js" type="text/javascript"></script>
  <script src="js/pong.js" type="text/javascript"></script>
  <script src="js/pubgame.js" type="text/javascript"></script>
  <script src="js/utils.js" type="text/javascript"></script>


  <script src="node_modules/pubnub/dist/web/pubnub.min.js"></script>
  <script src="node_modules/qrcode-generator/qrcode.js"></script>


  <script type="text/javascript">

    var makeQRCode = function(props){
       var gameQRCode = qrcode(4,'L');
       var targ = props.text.replace(/^[\s\u3000]+|[\s\u3000]+$/g, '');
       var t = targ.replace(/^[\s\u3000]+|[\s\u3000]+$/g, '');
       gameQRCode.addData(t);
       gameQRCode.make();
       return gameQRCode.createSvgTag();
    }


    var rand = Math.floor(Math.random()*10000);

    var pubnub = new PubNub({
      publishKey: 'pub-c-0ecaf3c4-bc3a-4e03-94e7-e85e196fdc4c',
      subscribeKey: 'sub-c-673a62aa-24c9-11e4-a77a-02ee2ddab7fe'
    });


    var presenceCallback = function(status, response){
         if ((response.channels["pongnub" + rand]) && (response.channels["pongnub" + rand].occupancy > 0)){
           if ($("#game").attr('src') !== ("game.html?id=" + rand)){
            $("#game").attr("src", "game.html?id=" + rand);
           }
         }
      };


    var chan = "pongnub" + rand;
    var z = setInterval(function() {
        pubnub.hereNow({
          channels: [chan]
          ,includeState: false
          ,includeUUIDS: false},
          presenceCallback);
    }, 1000);


    $("#controlLink").attr("href", "controller.html?id=" + rand);
    function calculateLink() {
      var p = window.location.pathname;
      var n = p.lastIndexOf('/');
      var p2 = p.substring(0,n+1);
      var controllerURL = window.location.origin + p2 + "controller.html?id=" + rand;
      console.log("window location is", controllerURL);
      return controllerURL;
    }
    var props = { text: calculateLink(),
                width: 164,
                height: 164,
                colorDark: "#444",
                colorLight: "#ffffff"
              };

  var qrCode = document.getElementById('qrcode');
  qrCode.innerHTML = makeQRCode(props);

  </script>

  <div id="loading">
    <div class="mask"></div>
    <div class="indication">
      <img src="./assets/loading.gif">
      <h3 class="text-red">Loading...</h3>
    </div>
  </div>



</body>

</html>
